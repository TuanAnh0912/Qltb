@using qltb.Data.ResVMs
@model PhieuDeNghiMuaSamResVM
@{
    ViewBag.Title = "Thông tin phiếu đề nghị mua sắm";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var SuccessNotification = TempData["SUCCESS"];
    var WarningNotification = TempData["WARNING"];
}


<div class="modal fade" id="add-modal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chọn thiết bị</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="overflow-x: auto">
                <form id="search-chon-thiet-bi-form">
                    <div class="row">
                        <div class="col-lg-4 col-md-6 col-sm-6 col-12">
                            <div class="form-group">
                                <label class="control-label">Môn học</label>
                                <select class="form-control" name="MonHocId" data-toggle="select2" data-placeholder="Chọn môn học" data-allow-clear="true">
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 col-sm-6 col-12">
                            <div class="form-group">
                                <label class="control-label">Tên thiết bị</label>
                                <input class="form-control" type="text" name="TenThietBi" placeholder="Tên thiết bị..." value="" />
                            </div>
                        </div>
                    </div>
                </form>
                <div class="row">
                    <div class="col-12" style="min-width: 800px">
                        <table class="table w-100" id="chon-thiet-bi-table">
                            <thead>
                                <tr>
                                    <th>Mã thiết bị</th>
                                    <th>Tên thiết bị</th>
                                    <th>Loại</th>
                                    <th>SL</th>
                                    <th>Đơn vị tính</th>
                                    <th style="min-width: 50px"></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Hủy</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="edit-modal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel"> </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="edit-thiet-bi-da-chon">
                    <div class="row">
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                            <div class="form-group">
                                <label class="control-label">SL tồn kho</label>
                                <input class="form-control" type="number" readonly name="SoLuong" min="0" value="0" />
                            </div>
                        </div>
                        <div class="col-lg-9 col-md-6 col-sm-6 col-12">
                            <div class="form-group">
                                <label class="control-label">Kinh phí</label>
                                <select class="form-control" name="KinhPhiId" data-toggle="select2" data-placeholder="Chọn kinh phí" data-allow-clear="false">
                                    <option value="1">Kinh phí từ cấp trên</option>
                                    <option value="2">Tự mua</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                            <div class="form-group">
                                <label class="control-label">SL Đề nghị</label>
                                <input class="form-control" type="number" name="SoLuongDeNghi" min="0" value="0" />
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                            <div class="form-group">
                                <label class="control-label">Đơn giá</label>
                                <input class="form-control" type="number" name="DonGia" min="0" value="0" />
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                            <div class="form-group">
                                <label class="control-label">Thành tiền</label>
                                <input class="form-control" type="number" readonly name="ThanhTien" min="0" value="0" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="update-thiet-bi-da-chon-btn">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="chot-phieu-modal" tabindex="-1" role="dialog" aria-labelledby="chotPhieuModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bạn có chắc chắn chốt phiếu</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="ChotPhieu()">Chốt phiếu</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="da-xu-ly-phieu-modal" tabindex="-1" role="dialog" aria-labelledby="daXuLyPhieuModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bạn có chắc chắn xác nhận đã xử lý</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="DaXuLy()">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<div class="page-section">
    <header class="page-title-bar">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item active">
                    <a href="/quan-ly-thiet-bi/danh-sach-phieu-de-nghi-mua-sam"><i class="breadcrumb-icon fa fa-angle-left mr-2"></i>Cập nhật phiếu đề nghị sửa chữa</a>
                </li>
            </ol>
        </nav>
    </header>
    <div class="row">
        <div class="col-12">
            <div class="card card-fluid">
                <div class="card-header">
                    <label>Thông tin phiếu đề nghị sửa chữa</label>
                    @if (Model.ChotPhieu.Value)
                    {
                        if (Model.DaXuLy.Value)
                        {
                            <span>(<span style="color: green"> Phiếu đã được xử lý </span>)</span>
                        }
                        else
                        {
                            <span>(<span style="color: green"> Phiếu đã được chốt </span>)</span>
                        }
                    }
                    <div class="float-right">
                        @if (!Model.DaXuLy.Value && Model.ChotPhieu.Value)
                        {
                            <button class="btn btn-sm btn-outline-primary" data-toggle="modal" data-target="#da-xu-ly-phieu-modal">Xác nhận xử lý</button>
                        }
                        @if (!Model.ChotPhieu.Value)
                        {
                            <button class="btn btn-sm btn-outline-primary" data-toggle="modal" data-target="#chot-phieu-modal">Chốt phiếu</button>
                        }
                        @if (!Model.ChotPhieu.Value)
                        {
                            <button class="btn btn-sm btn-success" onclick="EditPhieuDeNghiMuaSam()">Cập nhật</button>
                        }
                    </div>
                </div>
                <div class="card-body">
                    <form id="edit-phieu-de-nghi-mua-sam-form">
                        <div class="row">
                            <div class="col-lg-3 col-md-4 col-sm-4 col-12">
                                <div class="form-group">
                                    <label>Số phiếu (Nếu có)</label>
                                    <input class="form-control" type="text" name="SoPhieu" placeholder="Số phiếu..." value="@(string.IsNullOrEmpty(Model.SoPhieu) ? "" : Model.SoPhieu )" />
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-4 col-sm-4 col-12">
                                <div class="form-group">
                                    <label>Ngày lập</label>
                                    <input class="form-control" type="date" name="NgayLap" value="@(Model.NgayLap.HasValue ? Model.NgayLap.Value.ToString("yyyy-MM-dd") : "")" />
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-4 col-sm-4 col-12">
                                <div class="form-group">
                                    <label>Nội dung</label>
                                    <input class="form-control" type="text" name="NoiDung" placeholder="Nội dung..." value="@(string.IsNullOrEmpty(Model.NoiDung) ? "" : Model.NoiDung)" />
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-group">
                                    <label>Tài liệu đính kèm</label>
                                    <input type="file" name="FileDinhKem">
                                </div>
                                <div id="tai-lieu-dinh-kem-div">
                                    <div class="row">

                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card card-fluid">
                <div class="card-header">
                    <h5>Danh sách thiết bị</h5>
                    <div class="float-right">
                        <button class="btn btn-sm btn-primary" onclick="OpenChonThietBi()">Chọn thiết bị</button>
                    </div>
                </div>
                <div class="card-body" style="overflow-x: auto">
                    <div style="min-width: 1000px">
                        <table class="table" id="thiet-bi-da-chon-table">
                            <thead>
                                <tr>
                                    <th>Mã thiết bị</th>
                                    <th>Tên thiết bị</th>
                                    <th>Loại</th>
                                    <th>Kinh phí</th>
                                    <th>SL tồn kho</th>
                                    <th>Đơn vị tính</th>
                                    <th>SL đề nghị</th>
                                    <th>Đơn giá</th>
                                    <th>Thành tiền</th>
                                    <th style="min-width: 100px"></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section style{
    <link href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css" />
    <style>
        #tai-lieu-dinh-kem-div > div > div {
            position: relative;
            text-align: center;
        }

            #tai-lieu-dinh-kem-div > div > div:hover > div {
                position: relative;
                visibility: visible;
                position: absolute;
                top: 0;
                right: 17px;
                cursor: pointer;
            }

            #tai-lieu-dinh-kem-div > div > div > div {
                visibility: hidden;
                position: relative;
                position: absolute;
                top: 0;
                right: 17px;
            }


                #tai-lieu-dinh-kem-div > div > div > div i {
                    color: lightcoral;
                    font-size: 18px
                }

                #tai-lieu-dinh-kem-div > div > div > div:hover i {
                    color: red
                }
    </style>
}


@section scripts{
    <script src="~/assets/javascript/hanhnd_1.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
    <script>
        let thietBiDaChons = [];
        let phieuDeNghiMuaSamId = '@(Model.PhieuDeNghiMuaSamId)'
        let taiLieuDinhKems = [];

        function ChotPhieu() {
            $.ajax({
                url: "/quan-ly-thiet-bi/chot-phieu-de-nghi-mua-sam",
                type: "post",
                data: {
                    phieuDeNghiMuaSamId: phieuDeNghiMuaSamId
                },
                success: function (response) {
                    location.reload();
                },
                error: function (xhr) {
                    //Do Something to handle error
                }
            });
        }

        function DaXuLy() {
            $.ajax({
                url: "/quan-ly-thiet-bi/xu-ly-phieu-de-nghi-mua-sam",
                type: "post",
                data: {
                    phieuDeNghiMuaSamId: phieuDeNghiMuaSamId
                },
                success: function (response) {
                    location.reload();
                },
                error: function (xhr) {
                    //Do Something to handle error
                }
            });
        }

        function EditPhieuDeNghiMuaSam() {
            let data = { ChiTietPhieuDeNghiMuaSams: thietBiDaChons, phieuDeNghiMuaSamId: phieuDeNghiMuaSamId, TaiLieuDinhKems: taiLieuDinhKems  }
            $("#edit-phieu-de-nghi-mua-sam-form").serializeArray().forEach(ele => {
                data[ele.name] = ele.value
            })
            if (!data.NgayLap) {
                toastr["warning"]('Chưa nhập ngày lập');
            }
            else if (!data.ChiTietPhieuDeNghiMuaSams || data.ChiTietPhieuDeNghiMuaSams.length == 0) {
                toastr["warning"]('Chưa chọn thiết bị');
            }
            else {
                $.ajax({
                    url: "/quan-ly-thiet-bi/cap-nhat-thong-tin-phieu-de-nghi-mua-sam",
                    type: "post",
                    data: data,
                    success: function (response) {
                        location.reload();
                    },
                    error: function (xhr) {
                        //Do Something to handle error
                    }
                });
            }

        }

        function OpenChonThietBi() {
            let t;
            $('#add-modal').modal('show');
            $("#search-chon-thiet-bi-form input").prop("disabled", true);
            $('#chon-thiet-bi-table').DataTable().clear().draw();;
            GetMonHocs($("#search-chon-thiet-bi-form select[name=MonHocId]"));

            $('#search-chon-thiet-bi-form select[name=MonHocId]').on('select2:select', function (e) {
                if (e.params.data) {
                    if (e.params.data.selected) {
                        $("#search-chon-thiet-bi-form input").val('');
                        $("#search-chon-thiet-bi-form input").prop("disabled", false);
                        if (t) {
                            clearTimeout(t);
                        }
                        t = setTimeout(function () {
                            GetDanhSachChonThietBi();
                        }, 400);
                    }
                }
            });

            $('#search-chon-thiet-bi-form select[name=MonHocId]').on('select2:clear', function (e) {
                $("#search-chon-thiet-bi-form input").val('');
                $("#search-chon-thiet-bi-form input").prop("disabled", true);
            });

            $("#search-chon-thiet-bi-form input").keyup(function () {
                if (t) {
                    clearTimeout(t);
                }
                t = setTimeout(function () {
                    GetDanhSachChonThietBi();
                }, 400);
            })
        }

        function GetDanhSachChonThietBi() {
            let dataSearch = {};

            $('#search-chon-thiet-bi-form').serializeArray().forEach(ele => {
                dataSearch[ele.name] = ele.value
            })
            $.ajax({
                url: "/quan-ly-thiet-bi/danh-sach-thiet-bi-ton-trong-kho",
                type: "get",
                data: dataSearch,
                success: function (response) {
                    let data = [];
                    response.forEach(ele => {
                        let item = [];
                        item.push(ele["MaThietBi"] ? ele["MaThietBi"] : '');
                        item.push(ele["TenThietBi"] ? ele["TenThietBi"] : '');
                        item.push(ele["TenLoaiThietBi"] ? ele["TenLoaiThietBi"] : '');
                        item.push(ele["SoLuong"] ? ele["SoLuong"] : '0');
                        item.push(ele["TenDonViTinh"] ? ele["TenDonViTinh"] : '');
                        if (thietBiDaChons.findIndex(x => x.ThietBiId.toString() === ele["ThietBiId"].toString()) == -1) {
                            item.push('<button class="btn btn-sm btn-outline-primary" onClick="ChonThietBi(\'' + ele["ThietBiId"] + '\', \'' + ele["KhoPhongId"] + '\')">Chọn</button>')
                        }
                        else {
                            item.push('<button class="btn btn-sm btn-success">Đã chọn</button>')
                        }
                        data.push(item)
                    })
                    let table = $('#chon-thiet-bi-table').DataTable();
                    table.clear();
                    table.rows.add(data)
                    table.draw();

                },
                error: function (xhr) {
                    //Do Something to handle error
                }
            });
        }

        function ChonThietBi(thietBiId, khoPhongId) {
            var index = thietBiDaChons.findIndex(x => x.ThietBiId.toString() === thietBiId.toString());
            if (index == -1) {
                $.ajax({
                    url: "/quan-ly-thiet-bi/thong-tin-thiet-bi-ton-trong-kho",
                    type: "get",
                    data: {
                        thietBiId: thietBiId,
                        khoPhongId: khoPhongId
                    },
                    success: function (response) {
                        let ele = response;
                        let data = [];
                        let item = [];
                        let id = (new Date()).valueOf().toString();
                        item.push(ele["MaThietBi"] ? ele["MaThietBi"] : '');
                        item.push(ele["TenThietBi"] ? ele["TenThietBi"] : '');
                        item.push(ele["TenLoaiThietBi"] ? ele["TenLoaiThietBi"] : '');
                        item.push(ele["TenKinhPhi"] ? ele["TenKinhPhi"] : 'Kinh phí từ cấp trên');
                        item.push(ele["SoLuong"] ? ele["SoLuong"] : '0');
                        item.push(ele["TenDonViTinh"] ? ele["TenDonViTinh"] : '');
                        item.push('0'); // so luong de nghi
                        item.push('0'); // don gia
                        item.push('0'); // thanh tien
                        item.push(`<button class="btn btn-sm btn-info" onClick="EditThietBiDaChon('` + id + `')">Sửa</button>
                                                                                <button class="btn btn-sm btn-outline-danger" onClick="DeleteThietBiDaChon('` + id + `')">Xóa</button>`);
                        data.push(item)

                        let table = $('#thiet-bi-da-chon-table').DataTable();
                        table.rows.add(data)
                        table.draw();
                        thietBiDaChons.push({ ...response, id: id.toString(), KinhPhi: 1, SoLuongDeNghi: 0, DonGia: 0, ThanhTien: 0, TenKinhPhi: "Kinh phí từ cấp trên", KinhPhiId: 1 })
                        $('#add-modal').modal('toggle');
                        toastr["success"]('Chọn thành công')
                    },
                    error: function (xhr) {
                        //Do Something to handle error
                    }
                });
            }
            else {
                toastr["warning"]('Đã chọn thiết bị này')
            }
        }

        function DeleteThietBiDaChon(thietBiDaChonId) {
            var index = thietBiDaChons.findIndex(ele => {
                return ele.id === thietBiDaChonId.trim();
            })
            if (index !== -1) thietBiDaChons.splice(index, 1);
            ReDrawThietBiDaChonTable();
            toastr["success"]('Xóa thành công');
        }

        function EditThietBiDaChon(thietBiDaChonId) {
            let thietBiDaChon = thietBiDaChons.find(x => x.id === thietBiDaChonId);
            if (thietBiDaChon) {
                $("#editModalLabel").html("Tên thiết bị: " + thietBiDaChon.TenThietBi)
                $("#edit-thiet-bi-da-chon input[name=SoLuong]").val(thietBiDaChon.SoLuong);
                $("#edit-thiet-bi-da-chon input[name=SoLuongDeNghi]").val(thietBiDaChon.SoLuongDeNghi);
                $("#edit-thiet-bi-da-chon input[name=DonGia]").val(thietBiDaChon.DonGia);
                $("#edit-thiet-bi-da-chon input[name=ThanhTien]").val(thietBiDaChon.ThanhTien);

                $('#edit-thiet-bi-da-chon select[name=KinhPhiId]').val(thietBiDaChon.KinhPhiId).trigger('change')
                $("#update-thiet-bi-da-chon-btn").unbind();
                $("#update-thiet-bi-da-chon-btn").click(function () {
                    UpdateThietBiDaChon(thietBiDaChon.id);
                });

                $("#edit-thiet-bi-da-chon input[name=SoLuongDeNghi]").off();
                $("#edit-thiet-bi-da-chon input[name=SoLuongDeNghi]").on('change keyup', function () {
                    let thanhTien = parseInt($(this).val()) * parseInt($("#edit-thiet-bi-da-chon input[name=DonGia]").val());
                    $("#edit-thiet-bi-da-chon input[name=ThanhTien]").val(thanhTien);
                });

                $("#edit-thiet-bi-da-chon input[name=DonGia]").unbind();
                $("#edit-thiet-bi-da-chon input[name=DonGia]").on('change keyup', function () {
                    let thanhTien = parseInt($(this).val()) * parseInt($("#edit-thiet-bi-da-chon input[name=SoLuongDeNghi]").val());
                    $("#edit-thiet-bi-da-chon input[name=ThanhTien]").val(thanhTien);
                });

                $('#edit-modal').modal('toggle');
            }
        }

        function UpdateThietBiDaChon(thietBiDaChonId) {
            var index = thietBiDaChons.findIndex(x => x.id === thietBiDaChonId);
            $("#edit-thiet-bi-da-chon").serializeArray().forEach(ele => {
                thietBiDaChons[index][ele.name] = ele.value;
            })
            ReDrawThietBiDaChonTable();
            toastr["success"]('Cập nhật thành công');
            $('#edit-modal').modal('toggle');
        }

        function ReDrawThietBiDaChonTable() {
            let table = $('#thiet-bi-da-chon-table').DataTable();
            let data = [];
            thietBiDaChons.forEach(ele => {
                let item = [];
                item.push(ele["MaThietBi"] ? ele["MaThietBi"] : '');
                item.push(ele["TenThietBi"] ? ele["TenThietBi"] : '');
                item.push(ele["TenLoaiThietBi"] ? ele["TenLoaiThietBi"] : '');
                item.push(ele["TenKinhPhi"] ? ele["TenKinhPhi"] : (ele["KinhPhiId"] && ele["KinhPhiId"] == 1 ? "Kinh phí từ cấp trên" : "Tự mua"));
                item.push(ele["SoLuong"] ? ele["SoLuong"] : '0');
                item.push(ele["TenDonViTinh"] ? ele["TenDonViTinh"] : '');
                item.push(ele["SoLuongDeNghi"] ? ele["SoLuongDeNghi"] : '0');
                item.push(ele["DonGia"] ? ele["DonGia"] : '0');
                item.push(ele["ThanhTien"] ? ele["ThanhTien"] : '0');
                item.push(`<button class="btn btn-sm btn-info" onClick="EditThietBiDaChon('` + ele["id"] + `')">Sửa</button>
                                                                        <button class="btn btn-sm btn-outline-danger" onClick="DeleteThietBiDaChon('` + ele["id"] + `')">Xóa</button>`)
                data.push(item)
            });
            table.clear();
            table.rows.add(data)
            table.draw();
        }

        function GetMonHocs(item) {
            return $.ajax({
                url: "/tu-dien/danh-sach-mon-hoc",
                type: "get",
                success: function (response) {
                    response.unshift({ MonHocId: 0, TenMonHoc: 'Dùng chung' })
                    item.html('').select2({ data: [{ id: '', text: '' }] });
                    item.select2({
                        data: response.map(ele => {
                            return { ...ele, id: ele.MonHocId, text: ele.TenMonHoc ? ele.TenMonHoc : '' }
                        }),
                        language: {
                            noResults: function () {
                                return "Không có dữ liệu";
                            }
                        },
                    })
                },
                error: function (xhr) {
                    //Do Something to handle error
                }
            });

        }

        function ReDrawTaiLieuDinhKem() {
            let content = "";
            taiLieuDinhKems.forEach(ele => {
                content += `<div class="col-xl-2 col-lg-2 col-md-3 col-sm-4 col-6">
                                                    <a target="_blank" href="/`+ ele.Url + `">
                                                        <img src="`+ ele.Icon + `" />
                                                        <div>
                                                            `+ ele.TenFile + `
                                                        </div>
                                                    </a>
                                                    <div class="delete-tai-lieu-dinh-kiem-div">
                                                        <i class="fas fa-minus-circle" onClick="RemoveTaiLieuDinhKiem('`+ ele.FileId + `')"></i>
                                                    </div>
                                                </div>`;
            })
            $("#tai-lieu-dinh-kem-div > div").html(content);
        }

        function RemoveTaiLieuDinhKiem(fileId) {
            var index = taiLieuDinhKems.findIndex(ele => {
                return ele.FileId === fileId.trim();
            })
            if (index !== -1) taiLieuDinhKems.splice(index, 1);
            ReDrawTaiLieuDinhKem();
        }

        $(document).ready(function () {
            if ('@(SuccessNotification)') {
                toastr["success"]('@(SuccessNotification)')
            }
            else if ('@(WarningNotification)') {
                toastr["warning"]('@(WarningNotification)')
            }

            $('#thiet-bi-da-chon-table').DataTable({
                "data": [],
                "columns": [
                    { "dataProp": "MaThietBi" },
                    { "dataProp": "TenThietBi" },
                    { "dataProp": "TenLoaiThietBi" },
                    { "dataProp": "KinhPhi" },
                    { "dataProp": "SoLuong" },
                    { "dataProp": "TenDonViTinh" },
                    { "dataProp": "SoLuongDeNghi" },
                    { "dataProp": "DonGia" },
                    { "dataProp": "ThanhTien" },
                    { "dataProp": "Action" },
                ],
                bLengthChange: false,
                bInfo: false,
                language: {
                    emptyTable: "Không có dữ liệu",
                    paginate: {
                        previous: '‹',
                        next: '›'
                    },
                    search: 'Tìm kiếm'
                },
                pageLength: 10,
            });

            $.ajax({
                url: "/quan-ly-thiet-bi/chi-tiet-phieu-de-nghi-mua-sam",
                type: "get",
                data: {
                    phieuDeNghiMuaSamId: phieuDeNghiMuaSamId
                },
                success: function (response) {
                    let i = 0;
                    thietBiDaChons = response.ChiTietThietBis.map(ele => {
                        i++;
                        let thanhTien = ele["SoLuongDeNghi"] * ele["DonGia"]
                        return { ...ele, id: i.toString(), ThanhTien: thanhTien }
                    });
                    ReDrawThietBiDaChonTable();

                    taiLieuDinhKems = response.FileTrongPhieuDeNghiMuaSams;
                    ReDrawTaiLieuDinhKem();

                },
                error: function (xhr) {
                    //Do Something to handle error
                }
            });

            $("#edit-phieu-de-nghi-mua-sam-form input[name=FileDinhKem]").on('input', function (e) {
                var fd = new FormData();
                var files = $('#edit-phieu-de-nghi-mua-sam-form input[name=FileDinhKem]')[0].files;
                if (files.length > 0) {
                    fd.append('file', files[0]);
                    $.ajax({
                        url: '/upload/upload-file-phieu-de-nghi-mua-sam',
                        type: 'post',
                        data: fd,
                        contentType: false,
                        processData: false,
                        success: function (response) {
                            taiLieuDinhKems.push(response);
                            ReDrawTaiLieuDinhKem();
                        },
                    });
                }
            })

            $('#chon-thiet-bi-table').DataTable({
                "data": [],
                "columns": [
                    { "dataProp": "MaThietBi" },
                    { "dataProp": "TenThietBi" },
                    { "dataProp": "Loai" },
                    { "dataProp": "SoLuongConLai" },
                    { "dataProp": "TenDonViTinh" },
                    { "dataProp": "Action" },
                ],
                bLengthChange: false,
                bInfo: false,
                language: {
                    emptyTable: "Không có dữ liệu",
                    paginate: {
                        previous: '‹',
                        next: '›'
                    },
                },
                pageLength: 10,
                searching: false
            });

        });
    </script>
}